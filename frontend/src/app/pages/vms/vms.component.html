<div class="vms-container">
  <nz-card>
    <div class="page-header">
      <div class="header-content">
        <h2>虚拟机管理</h2>
        <p>管理系统中的所有虚拟机</p>
      </div>
      <div class="header-actions">
        <button nz-button nzType="primary" (click)="showCreateModal()">
          <span nz-icon nzType="plus"></span>
          新建虚拟机
        </button>
      </div>
    </div>

    <nz-spin [nzSpinning]="loading">
      <nz-table 
        #basicTable 
        [nzData]="vms"
        [nzPageSize]="pagination.per_page"
        [nzPageIndex]="pagination.current_page"
        [nzTotal]="pagination.total"
        [nzFrontPagination]="false"
        [nzShowSizeChanger]="true"
        [nzShowQuickJumper]="true"
        [nzShowTotal]="totalTemplate"
        (nzPageIndexChange)="onPageIndexChange($event)"
        (nzPageSizeChange)="onPageSizeChange($event)"
      >
        <thead>
          <tr>
            <th>ID</th>
            <th>名称</th>
            <th>状态</th>
            <th>节点</th>
            <th>操作系统</th>
            <th>CPU</th>
            <th>内存</th>
            <th>创建时间</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let vm of vms">
            <td>{{ vm.id }}</td>
            <td>
              <strong>{{ vm.name }}</strong>
              <br>
              <small class="uuid-text">{{ vm.uuid }}</small>
            </td>
            <td>
              <nz-tag [nzColor]="getStatusColor(vm.status)">
                {{ getStatusText(vm.status) }}
              </nz-tag>
            </td>
            <td>
              <div class="node-info">
                <strong>{{ vm.node_name }}</strong>
                <br>
                <small class="node-id">ID: {{ vm.node_id }}</small>
              </div>
            </td>
            <td>
              <nz-tag [nzColor]="vm.os_type === 'windows' ? 'blue' : 'green'">
                {{ vm.os_type === 'windows' ? 'Windows' : 'Linux' }}
              </nz-tag>
            </td>
            <td>
              <span class="resource-info">{{ vm.vcpu }} 核</span>
            </td>
            <td>
              <span class="resource-info">{{ formatMemory(vm.memory_mb) }}</span>
            </td>
            <td>
              <span class="time-info">{{ vm.created_at | date:'yyyy-MM-dd HH:mm' }}</span>
            </td>
            <td>
              <div class="action-buttons">
                <!-- 主要操作按钮 -->
                <!-- 详情按钮保留在列表中 -->
                <button nz-button nzType="link" nzSize="small" (click)="showDetailModal(vm)" class="action-btn detail-btn">
                  <span nz-icon nzType="eye"></span>
                  详情
                </button>
                
                <!-- 更多操作下拉菜单 -->
                <a nz-dropdown [nzDropdownMenu]="menu" class="action-btn more-btn">
                  更多
                  <nz-icon nzType="down" />
                </a>
                <nz-dropdown-menu #menu="nzDropdownMenu">
                  <ul nz-menu nzSelectable>
                    <!-- 状态控制操作 -->
                    <li nz-menu-item *ngIf="vm.status === 'stopped'" (click)="startVm(vm)">
                      <span nz-icon nzType="play-circle"></span>
                      启动
                    </li>
                    <li nz-menu-item *ngIf="vm.status === 'running'" (click)="stopVm(vm)">
                      <span nz-icon nzType="pause-circle"></span>
                      停止
                    </li>
                    <li nz-menu-item *ngIf="vm.status === 'stopping'" nzDisabled>
                      <span nz-icon nzType="loading"></span>
                      停止中...
                    </li>
                    <li nz-menu-item *ngIf="vm.status === 'running'" (click)="restartVm(vm)">
                      <span nz-icon nzType="reload"></span>
                      重启
                    </li>
                    
                    <li nz-menu-item (click)="showEditModal(vm)">
                      <span nz-icon nzType="edit"></span>
                      编辑
                    </li>
                    
                    <li nz-menu-divider></li>
                    
                    <!-- 危险操作 -->
                    <li nz-menu-item nzDanger (click)="deleteVm(vm)">
                      <span nz-icon nzType="delete"></span>
                      删除
                    </li>
                  </ul>
                </nz-dropdown-menu>
              </div>
            </td>
          </tr>
        </tbody>
      </nz-table>
    </nz-spin>
  </nz-card>
</div>

<!-- 创建/编辑虚拟机模态框 -->
<nz-modal
  [(nzVisible)]="isModalVisible"
  [nzTitle]="isEditMode ? '编辑虚拟机' : '新建虚拟机'"
  [nzWidth]="600"
  (nzOnCancel)="handleCancel()"
  (nzOnOk)="handleOk()"
>
  <div *nzModalContent>
    <form nz-form>
      <!-- 基础配置区域 -->
      <div class="config-section">
        <h4 class="section-title">基础配置</h4>
        <nz-form-item>
          <nz-form-label [nzSpan]="6">虚拟机名称</nz-form-label>
          <nz-form-control [nzSpan]="18">
            <input 
              nz-input 
              placeholder="请输入虚拟机名称" 
              [(ngModel)]="formData.name"
              [ngModelOptions]="{standalone: true}"
              name="name"
            />
          </nz-form-control>
        </nz-form-item>

        <nz-form-item>
          <nz-form-label [nzSpan]="6">部署节点</nz-form-label>
          <nz-form-control [nzSpan]="18">
            <nz-select 
              nzPlaceHolder="请选择部署节点" 
              [(ngModel)]="formData.node_id"
              [ngModelOptions]="{standalone: true}"
              name="node_id"
              nzAllowClear
            >
              <nz-option 
                *ngFor="let node of nodes" 
                [nzValue]="node.id" 
                [nzLabel]="node.hostname + ' (' + node.ip + ')'"
              ></nz-option>
            </nz-select>
          </nz-form-control>
        </nz-form-item>

        <nz-form-item>
          <nz-form-label [nzSpan]="6">CPU 核数</nz-form-label>
          <nz-form-control [nzSpan]="18">
            <nz-input-number 
              [(ngModel)]="formData.vcpu"
              [ngModelOptions]="{standalone: true}"
              name="vcpu"
              [nzMin]="1"
              [nzMax]="32"
              [nzStep]="1"
              nzPlaceHolder="请输入CPU核数"
              style="width: 100%"
            ></nz-input-number>
          </nz-form-control>
        </nz-form-item>

        <nz-form-item>
          <nz-form-label [nzSpan]="6">内存大小 (MB)</nz-form-label>
          <nz-form-control [nzSpan]="18">
            <nz-input-number 
              [(ngModel)]="formData.memory_mb"
              [ngModelOptions]="{standalone: true}"
              name="memory_mb"
              [nzMin]="512"
              [nzMax]="131072"
              [nzStep]="512"
              nzPlaceHolder="请输入内存大小"
              style="width: 100%"
            ></nz-input-number>
          </nz-form-control>
        </nz-form-item>

        <nz-form-item>
          <nz-form-label [nzSpan]="6">操作系统类型</nz-form-label>
          <nz-form-control [nzSpan]="18">
            <nz-select 
              nzPlaceHolder="请选择操作系统类型" 
              [(ngModel)]="formData.os_type"
              [ngModelOptions]="{standalone: true}"
              name="os_type"
              nzAllowClear
            >
              <nz-option nzValue="linux" nzLabel="Linux"></nz-option>
              <nz-option nzValue="windows" nzLabel="Windows"></nz-option>
            </nz-select>
          </nz-form-control>
        </nz-form-item>

        <nz-form-item *ngIf="!isEditMode">
          <nz-form-label [nzSpan]="6">选择网络</nz-form-label>
          <nz-form-control [nzSpan]="18">
            <nz-select 
              nzPlaceHolder="请选择网络" 
              [(ngModel)]="formData.selected_network_id"
              [ngModelOptions]="{standalone: true}"
              name="selected_network_id"
              nzAllowClear
            >
              <nz-option 
                *ngFor="let network of availableNetworks" 
                [nzValue]="network.id" 
                [nzLabel]="network.name + ' (' + network.cidr + ')'"
              ></nz-option>
            </nz-select>
          </nz-form-control>
        </nz-form-item>
      </div>

      <!-- 磁盘配置区域 -->
      <div class="config-section" *ngIf="!isEditMode">
        <h4 class="section-title">磁盘配置</h4>
        <nz-form-item>
          <nz-form-control [nzSpan]="24">
            <div class="disk-config">
              <nz-table 
                [nzData]="formData.disks" 
                [nzShowPagination]="false" 
                [nzBordered]="true"
                nzSize="small"
              >
                <thead>
                  <tr>
                    <th>存储卷</th>
                    <th>总线类型</th>
                    <th>设备类型</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let disk of formData.disks; let i = index">
                    <td>
                      <nz-select 
                        nzPlaceHolder="请选择存储卷" 
                        [(ngModel)]="disk.volume_id"
                        [ngModelOptions]="{standalone: true}"
                        nzAllowClear
                        style="width: 100%"
                      >
                        <nz-option 
                          *ngFor="let volume of getAvailableVolumes()" 
                          [nzValue]="volume.id" 
                          [nzLabel]="volume.name + ' (' + volume.size_gb + 'GB)'"
                        ></nz-option>
                      </nz-select>
                    </td>
                    <td>
                      <nz-select 
                        [(ngModel)]="disk.bus_type"
                        [ngModelOptions]="{standalone: true}"
                        style="width: 100%"
                      >
                        <nz-option nzValue="virtio" nzLabel="VirtIO"></nz-option>
                        <nz-option nzValue="scsi" nzLabel="SCSI"></nz-option>
                        <nz-option nzValue="ide" nzLabel="IDE"></nz-option>
                      </nz-select>
                    </td>
                    <td>
                      <nz-select 
                        [(ngModel)]="disk.device_type"
                        [ngModelOptions]="{standalone: true}"
                        style="width: 100%"
                      >
                        <nz-option nzValue="disk" nzLabel="磁盘"></nz-option>
                        <nz-option nzValue="cdrom" nzLabel="光驱"></nz-option>
                      </nz-select>
                    </td>
                    <td>
                      <button 
                        nz-button 
                        nzType="text" 
                        nzDanger 
                        nzSize="small"
                        (click)="removeDisk(i)" 
                        [disabled]="formData.disks.length === 1"
                      >
                        <i nz-icon nzType="delete"></i> 删除
                      </button>
                    </td>
                  </tr>
                </tbody>
              </nz-table>
              <div style="text-align: center; margin-top: 16px;">
                <button nz-button nzType="dashed" (click)="addDisk()">
                  <i nz-icon nzType="plus"></i> 添加磁盘
                </button>
              </div>
            </div>
          </nz-form-control>
        </nz-form-item>
      </div>
    </form>
  </div>
</nz-modal>

<!-- 虚拟机详情弹窗 -->
<nz-modal
  [(nzVisible)]="isDetailModalVisible"
  nzTitle="虚拟机详情"
  [nzWidth]="800"
  (nzOnCancel)="handleDetailCancel()"
  [nzFooter]="null"
>
  <div *nzModalContent>
    <div *ngIf="selectedVm" class="vm-detail-content">
      <!-- 基本信息 -->
      <nz-card nzTitle="基本信息" [nzBordered]="false" class="detail-section">
        <div class="detail-grid">
          <!-- 短信息 - 左右排列 -->
          <div class="detail-row">
            <div class="detail-item">
              <label>虚拟机名称:</label>
              <span>{{ selectedVm.name }}</span>
            </div>
            <div class="detail-item">
              <label>虚拟机ID:</label>
              <span>{{ selectedVm.id }}</span>
            </div>
          </div>
          
          <div class="detail-row">
            <div class="detail-item">
              <label>CPU核数:</label>
              <span>{{ selectedVm.vcpu }} 核</span>
            </div>
            <div class="detail-item">
              <label>内存大小:</label>
              <span>{{ formatMemory(selectedVm.memory_mb) }}</span>
            </div>
          </div>
          
          <div class="detail-row">
            <div class="detail-item">
              <label>操作系统:</label>
              <nz-tag [nzColor]="selectedVm.os_type === 'windows' ? 'blue' : 'green'">
                {{ selectedVm.os_type === 'windows' ? 'Windows' : 'Linux' }}
              </nz-tag>
            </div>
            <div class="detail-item">
              <label>状态:</label>
              <nz-tag [nzColor]="getStatusColor(selectedVm.status)">
                {{ getStatusText(selectedVm.status) }}
              </nz-tag>
            </div>
          </div>
          
          <div class="detail-row">
            <div class="detail-item">
              <label>创建时间:</label>
              <span>{{ selectedVm.created_at | date:'yyyy-MM-dd HH:mm:ss' }}</span>
            </div>
            <div class="detail-item">
              <label>更新时间:</label>
              <span>{{ selectedVm.updated_at | date:'yyyy-MM-dd HH:mm:ss' }}</span>
            </div>
          </div>
          
          <!-- 长信息 - 单独占一行 -->
          <div class="detail-item-full">
            <label>虚拟机ID:</label>
            <span class="long-text">{{ selectedVm.id }}</span>
          </div>
          
          <div class="detail-item-full">
            <label>部署节点:</label>
            <span class="long-text">{{ selectedVm.node_name }} (ID: {{ selectedVm.node_id }})</span>
          </div>
        </div>
      </nz-card>

      <!-- 存储卷信息 -->
      <nz-card [nzBordered]="false" class="detail-section">
        <div class="storage-header">
          <h3 class="storage-title">存储卷信息</h3>
          <button nz-button nzType="primary" nzSize="small" (click)="showAttachVolumeModal()">
            <span nz-icon nzType="plus"></span>
            挂载存储卷
          </button>
        </div>
        <nz-spin [nzSpinning]="volumesLoading">
          <div *ngIf="vmVolumes.length > 0; else noVolumes">
            <nz-table [nzData]="vmVolumes" [nzShowPagination]="false" nzSize="small">
              <thead>
                <tr>
                  <th>设备名</th>
                  <th>存储卷名称</th>
                  <th>大小</th>
                  <th>总线类型</th>
                  <th>设备类型</th>
                  <th>可启动</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let volume of vmVolumes">
                  <td>{{ volume.device }}</td>
                  <td>{{ volume.volume_name || '未知' }}</td>
                  <td>{{ volume.size_gb ? volume.size_gb + ' GB' : '未知' }}</td>
                  <td>
                    <nz-tag [nzColor]="getBusTypeColor(volume.bus_type)">
                      {{ getBusTypeText(volume.bus_type) }}
                    </nz-tag>
                  </td>
                  <td>
                    <nz-tag [nzColor]="volume.device_type === 'disk' ? 'blue' : 'orange'">
                      {{ volume.device_type === 'disk' ? '磁盘' : '光驱' }}
                    </nz-tag>
                  </td>
                  <td>
                    <nz-tag [nzColor]="volume.bootable ? 'green' : 'default'">
                      {{ volume.bootable ? '是' : '否' }}
                    </nz-tag>
                  </td>
                  <td>
                    <button 
                      nz-button 
                      nzType="text" 
                      nzDanger 
                      nzSize="small"
                      nz-popconfirm
                      nzPopconfirmTitle="确定要移除这个存储卷吗？"
                      nzPopconfirmPlacement="topRight"
                      (nzOnConfirm)="detachVolume(volume.volume_id)"
                      [disabled]="false"
                    >
                      <span nz-icon nzType="disconnect"></span>
                      移除
                    </button>
                  </td>
                </tr>
              </tbody>
            </nz-table>
          </div>
          <ng-template #noVolumes>
            <nz-empty nzNotFoundContent="暂无存储卷信息"></nz-empty>
          </ng-template>
        </nz-spin>
      </nz-card>

      <!-- 网络信息 -->
      <nz-card nzTitle="网络信息" [nzBordered]="false" class="detail-section">
        <nz-spin [nzSpinning]="networksLoading">
          <div *ngIf="vmNetworks.length > 0; else noNetworks">
            <nz-table [nzData]="vmNetworks" [nzShowPagination]="false" nzSize="small">
              <thead>
                <tr>
                  <th>网络名称</th>
                  <th>IP地址</th>
                  <th>MAC地址</th>
                  <th>网络模型</th>
                  <th>网桥名称</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let network of vmNetworks">
                  <td>{{ network.network_name || '未知' }}</td>
                  <td>{{ network.ip_address || '未分配' }}</td>
                  <td>{{ network.mac_address || '未分配' }}</td>
                  <td>{{ network.model || '未知' }}</td>
                  <td>{{ network.bridge_name || '未配置' }}</td>
                </tr>
              </tbody>
            </nz-table>
          </div>
          <ng-template #noNetworks>
            <nz-empty nzNotFoundContent="暂无网络信息"></nz-empty>
          </ng-template>
        </nz-spin>
      </nz-card>
    </div>
  </div>
</nz-modal>

<!-- 挂载存储卷模态框 -->
<nz-modal
  [(nzVisible)]="isAttachVolumeModalVisible"
  nzTitle="挂载存储卷"
  [nzWidth]="500"
  (nzOnCancel)="handleAttachVolumeCancel()"
  (nzOnOk)="handleAttachVolumeOk()"
  [nzOkLoading]="attachVolumeLoading"
>
  <div *nzModalContent>
    <form nz-form>
      <nz-form-item>
        <nz-form-label [nzSpan]="6">选择存储卷</nz-form-label>
        <nz-form-control [nzSpan]="18">
          <nz-select 
            nzPlaceHolder="请选择要挂载的存储卷" 
            [(ngModel)]="attachVolumeForm.volume_id"
            [ngModelOptions]="{standalone: true}"
            name="volume_id"
            nzAllowClear
            nzShowSearch
            (nzOnSearch)="searchAvailableVolumes($event)"
            [nzLoading]="availableVolumesLoading"
          >
            <nz-option 
              *ngFor="let volume of availableVolumes" 
              [nzValue]="volume.id" 
              [nzLabel]="volume.name + ' (' + volume.size_gb + 'GB)'"
            ></nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6">总线类型</nz-form-label>
        <nz-form-control [nzSpan]="18">
          <nz-select 
            [(ngModel)]="attachVolumeForm.bus_type"
            [ngModelOptions]="{standalone: true}"
            name="bus_type"
          >
            <nz-option nzValue="virtio" nzLabel="VirtIO (推荐)"></nz-option>
            <nz-option nzValue="scsi" nzLabel="SCSI"></nz-option>
            <nz-option nzValue="ide" nzLabel="IDE"></nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6">设备类型</nz-form-label>
        <nz-form-control [nzSpan]="18">
          <nz-select 
            [(ngModel)]="attachVolumeForm.device_type"
            [ngModelOptions]="{standalone: true}"
            name="device_type"
          >
            <nz-option nzValue="disk" nzLabel="磁盘"></nz-option>
            <nz-option nzValue="cdrom" nzLabel="光驱"></nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>
    </form>
  </div>
</nz-modal>

<ng-template #totalTemplate let-total>
  共 {{ total }} 条记录
</ng-template>

