<div class="storage-pools-container">
  <nz-card>
    <div class="page-header">
      <div class="header-content">
        <h2>存储池管理</h2>
        <p>管理系统中的存储池资源</p>
      </div>
      <div class="header-actions">
        <button 
          nz-button 
          nzType="primary" 
          (click)="showCreatePoolModal()"
        >
          <span nz-icon nzType="plus"></span>
          新建存储池
        </button>
      </div>
    </div>

    <nz-spin [nzSpinning]="loading">
      <nz-table 
        #poolsTable 
        [nzData]="storagePools"
        [nzPageSize]="pagination.per_page"
        [nzPageIndex]="pagination.current_page"
        [nzTotal]="pagination.total"
        [nzFrontPagination]="false"
        [nzShowSizeChanger]="true"
        [nzShowQuickJumper]="true"
        [nzShowTotal]="totalTemplate"
        (nzPageIndexChange)="onPageIndexChange($event)"
        (nzPageSizeChange)="onPageSizeChange($event)"
      >
        <thead>
          <tr>
            <th>ID</th>
            <th>名称</th>
            <th>类型</th>
            <th>状态</th>
            <th>总容量</th>
            <th>已使用</th>
            <th>可用空间</th>
            <th>使用率</th>
            <th>创建时间</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let pool of storagePools">
            <td>{{ pool.id }}</td>
            <td>
              <strong>{{ pool.name }}</strong>
            </td>
            <td>
              <nz-tag [nzColor]="getTypeColor(pool.type)">
                {{ getTypeText(pool.type) }}
              </nz-tag>
            </td>
            <td>
              <nz-tag [nzColor]="getStatusColor(pool.status)">
                {{ getStatusText(pool.status) }}
              </nz-tag>
            </td>
            <td>
              <span class="size-info">{{ formatSize(pool.total_size_gb) }}</span>
            </td>
            <td>
              <span class="size-info">{{ formatSize(pool.used_size_gb) }}</span>
            </td>
            <td>
              <span class="size-info">{{ formatSize(pool.available_size_gb) }}</span>
            </td>
            <td>
              <div class="usage-info">
                <span class="usage-percentage">{{ calculateUsagePercentage(pool.used_size_gb, pool.total_size_gb) }}%</span>
                <div class="usage-bar">
                  <div 
                    class="usage-fill" 
                    [style.width.%]="calculateUsagePercentage(pool.used_size_gb, pool.total_size_gb)"
                    [class.high-usage]="calculateUsagePercentage(pool.used_size_gb, pool.total_size_gb) > 80"
                  ></div>
                </div>
              </div>
            </td>
            <td>
              <span class="time-info">{{ pool.created_at | date:'yyyy-MM-dd HH:mm' }}</span>
            </td>
            <td>
              <div class="action-buttons">
                <button nz-button nzType="link" nzSize="small" (click)="showEditPoolModal(pool)" class="action-btn edit-btn">
                  <span nz-icon nzType="edit"></span>
                  编辑
                </button>
                <button 
                  nz-button 
                  nzType="link" 
                  nzSize="small" 
                  nzDanger 
                  class="action-btn delete-btn"
                  nz-popconfirm
                  nzPopconfirmTitle="确定要删除这个存储池吗？"
                  nzOkText="确定"
                  nzCancelText="取消"
                  (nzOnConfirm)="deletePool(pool)"
                >
                  <span nz-icon nzType="delete"></span>
                  删除
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </nz-table>
    </nz-spin>
  </nz-card>
</div>

<!-- 创建/编辑存储池模态框 -->
<nz-modal
  [(nzVisible)]="isModalVisible"
  [nzTitle]="isEditMode ? '编辑存储池' : '新建存储池'"
  [nzWidth]="600"
  (nzOnCancel)="handleCancel()"
  (nzOnOk)="handleOk()"
>
  <div *nzModalContent>
    <form nz-form>
      <nz-form-item>
        <nz-form-label [nzSpan]="6">存储池名称</nz-form-label>
        <nz-form-control [nzSpan]="18">
          <input 
            nz-input 
            placeholder="请输入存储池名称" 
            [(ngModel)]="poolFormData.name"
            name="name"
          />
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6">存储类型</nz-form-label>
        <nz-form-control [nzSpan]="18">
          <nz-select 
            nzPlaceHolder="请选择存储类型" 
            [(ngModel)]="poolFormData.pool_type"
            name="pool_type"
          >
            <nz-option nzValue="lvm" nzLabel="LVM (暂不可用)" nzDisabled="true"></nz-option>
            <nz-option nzValue="nfs" nzLabel="NFS"></nz-option>
            <nz-option nzValue="ceph" nzLabel="Ceph (暂不可用)" nzDisabled="true"></nz-option>
            <nz-option nzValue="iscsi" nzLabel="iSCSI (暂不可用)" nzDisabled="true"></nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6">总容量 (GB)</nz-form-label>
        <nz-form-control [nzSpan]="18">
          <nz-input-number 
            [(ngModel)]="poolFormData.capacity_gb"
            name="capacity_gb"
            [nzMin]="10"
            [nzMax]="10000"
            [nzStep]="10"
            nzPlaceHolder="请输入总容量"
            style="width: 100%"
          ></nz-input-number>
        </nz-form-control>
      </nz-form-item>
    </form>
  </div>
</nz-modal>

<ng-template #totalTemplate let-total>
  共 {{ total }} 条记录
</ng-template>
