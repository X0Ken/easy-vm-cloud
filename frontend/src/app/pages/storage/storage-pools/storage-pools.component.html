<div class="storage-pools-container">
  <nz-card>
    <div class="page-header">
      <div class="header-content">
        <h2>存储池管理</h2>
        <p>管理系统中的存储池资源</p>
      </div>
      <div class="header-actions">
        <button 
          nz-button 
          nzType="primary" 
          (click)="showCreatePoolModal()"
        >
          <span nz-icon nzType="plus"></span>
          新建存储池
        </button>
      </div>
    </div>

    <nz-spin [nzSpinning]="loading">
      <nz-table 
        #poolsTable 
        [nzData]="storagePools"
        [nzPageSize]="pagination.per_page"
        [nzPageIndex]="pagination.current_page"
        [nzTotal]="pagination.total"
        [nzFrontPagination]="false"
        [nzShowSizeChanger]="true"
        [nzShowQuickJumper]="true"
        [nzShowTotal]="totalTemplate"
        (nzPageIndexChange)="onPageIndexChange($event)"
        (nzPageSizeChange)="onPageSizeChange($event)"
      >
        <thead>
          <tr>
            <th>ID</th>
            <th>名称</th>
            <th>类型</th>
            <th>状态</th>
            <th>节点</th>
            <th>总容量</th>
            <th>已使用</th>
            <th>可用空间</th>
            <th>使用率</th>
            <th>创建时间</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let pool of storagePools">
            <td>{{ pool.id }}</td>
            <td>
              <strong>{{ pool.name }}</strong>
            </td>
            <td>
              <nz-tag [nzColor]="getTypeColor(pool.type)">
                {{ getTypeText(pool.type) }}
              </nz-tag>
            </td>
            <td>
              <nz-tag [nzColor]="getStatusColor(pool.status)">
                {{ getStatusText(pool.status) }}
              </nz-tag>
            </td>
            <td>
              <span class="node-info">{{ pool.node_name || '未分配' }}</span>
            </td>
            <td>
              <span class="size-info">{{ formatSize(pool.total_size_gb) }}</span>
            </td>
            <td>
              <span class="size-info">{{ formatSize(pool.used_size_gb) }}</span>
            </td>
            <td>
              <span class="size-info">{{ formatSize(pool.available_size_gb) }}</span>
            </td>
            <td>
              <div class="usage-info">
                <span class="usage-percentage">{{ calculateUsagePercentage(pool.used_size_gb, pool.total_size_gb) }}%</span>
                <div class="usage-bar">
                  <div 
                    class="usage-fill" 
                    [style.width.%]="calculateUsagePercentage(pool.used_size_gb, pool.total_size_gb)"
                    [class.high-usage]="calculateUsagePercentage(pool.used_size_gb, pool.total_size_gb) > 80"
                  ></div>
                </div>
              </div>
            </td>
            <td>
              <span class="time-info">{{ pool.created_at | date:'yyyy-MM-dd HH:mm' }}</span>
            </td>
            <td>
              <div class="action-buttons">
                <button nz-button nzType="link" nzSize="small" (click)="showEditPoolModal(pool)" class="action-btn edit-btn">
                  <span nz-icon nzType="edit"></span>
                  编辑
                </button>
                <button 
                  nz-button 
                  nzType="link" 
                  nzSize="small" 
                  nzDanger 
                  class="action-btn delete-btn"
                  nz-popconfirm
                  nzPopconfirmTitle="确定要删除这个存储池吗？"
                  nzOkText="确定"
                  nzCancelText="取消"
                  (nzOnConfirm)="deletePool(pool)"
                >
                  <span nz-icon nzType="delete"></span>
                  删除
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </nz-table>
    </nz-spin>
  </nz-card>
</div>

<!-- 创建/编辑存储池模态框 -->
<nz-modal
  [(nzVisible)]="isModalVisible"
  [nzTitle]="isEditMode ? '编辑存储池' : '新建存储池'"
  [nzWidth]="600"
  (nzOnCancel)="handleCancel()"
  (nzOnOk)="handleOk()"
>
  <div *nzModalContent>
    <form nz-form>
      <nz-form-item>
        <nz-form-label [nzSpan]="6">存储池名称</nz-form-label>
        <nz-form-control [nzSpan]="18">
          <input 
            nz-input 
            placeholder="请输入存储池名称" 
            [(ngModel)]="poolFormData.name"
            name="name"
          />
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6">存储类型</nz-form-label>
        <nz-form-control [nzSpan]="18">
          <nz-select 
            nzPlaceHolder="请选择存储类型" 
            [(ngModel)]="poolFormData.pool_type"
            name="pool_type"
          >
            <nz-option nzValue="lvm" nzLabel="LVM (暂不可用)" nzDisabled="true"></nz-option>
            <nz-option nzValue="nfs" nzLabel="NFS"></nz-option>
            <nz-option nzValue="ceph" nzLabel="Ceph (暂不可用)" nzDisabled="true"></nz-option>
            <nz-option nzValue="iscsi" nzLabel="iSCSI (暂不可用)" nzDisabled="true"></nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6">关联节点</nz-form-label>
        <nz-form-control [nzSpan]="18">
          <nz-select 
            nzPlaceHolder="请选择节点" 
            [(ngModel)]="poolFormData.node_id"
            name="node_id"
            nzAllowClear
          >
            <nz-option 
              *ngFor="let node of nodes" 
              [nzValue]="node.id.toString()" 
              [nzLabel]="node.hostname + ' (' + node.ip + ')'"
            ></nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6">总容量 (GB)</nz-form-label>
        <nz-form-control [nzSpan]="18">
          <nz-input-number 
            [(ngModel)]="poolFormData.capacity_gb"
            name="capacity_gb"
            [nzMin]="10"
            [nzMax]="10000"
            [nzStep]="10"
            nzPlaceHolder="请输入总容量"
            style="width: 100%"
          ></nz-input-number>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6">存储配置</nz-form-label>
        <nz-form-control [nzSpan]="18">
          <div class="config-input-wrapper">
            <textarea 
              nz-input 
              placeholder="请输入存储配置JSON，例如：{&quot;server&quot;:&quot;192.168.1.10&quot;,&quot;path&quot;:&quot;/data/nfs&quot;,&quot;mount_path&quot;:&quot;/data/nfs&quot;}"
              [(ngModel)]="poolFormData.configJson"
              name="configJson"
              rows="4"
              style="width: 100%"
            ></textarea>
            <button 
              nz-button 
              nzType="link" 
              nzSize="small" 
              class="config-example-btn"
              (click)="showConfigExamples()"
            >
              <span nz-icon nzType="question-circle"></span>
              查看配置示例
            </button>
          </div>
        </nz-form-control>
      </nz-form-item>
    </form>
  </div>
</nz-modal>

<!-- 配置示例弹窗 -->
<nz-modal
  [(nzVisible)]="isConfigExampleVisible"
  nzTitle="存储配置示例"
  [nzWidth]="700"
  (nzOnCancel)="handleConfigExampleCancel()"
  [nzFooter]="null"
>
  <div *nzModalContent>
    <div class="config-examples">
      <nz-tabs nzType="card">
        <nz-tab nzTitle="NFS">
          <div class="config-example">
            <h4>NFS 存储配置</h4>
            <p>适用于网络文件系统存储</p>
            <pre><code>{{ '{' }}
  "server": "192.168.1.10",
  "path": "/data/nfs",
  "mount_path": "/data/nfs"
{{ '}' }}</code></pre>
            <div class="config-description">
              <strong>字段说明：</strong>
              <ul>
                <li><code>server</code>: NFS服务器IP地址</li>
                <li><code>path</code>: NFS服务器上的导出路径</li>
                <li><code>mount_path</code>: 本地挂载路径</li>
              </ul>
            </div>
          </div>
        </nz-tab>
        
        <nz-tab nzTitle="LVM">
          <div class="config-example">
            <h4>LVM 存储配置</h4>
            <p>适用于逻辑卷管理存储</p>
            <pre><code>{{ '{' }}
  "volume_group": "vg_vm"
{{ '}' }}</code></pre>
            <div class="config-description">
              <strong>字段说明：</strong>
              <ul>
                <li><code>volume_group</code>: LVM卷组名称</li>
              </ul>
            </div>
          </div>
        </nz-tab>
        
        <nz-tab nzTitle="Ceph">
          <div class="config-example">
            <h4>Ceph 存储配置</h4>
            <p>适用于分布式存储系统</p>
            <pre><code>{{ '{' }}
  "monitors": ["192.168.1.10:6789", "192.168.1.11:6789"],
  "pool": "vms",
  "user": "admin",
  "keyring": "/etc/ceph/ceph.client.admin.keyring"
{{ '}' }}</code></pre>
            <div class="config-description">
              <strong>字段说明：</strong>
              <ul>
                <li><code>monitors</code>: Ceph Monitor节点地址列表</li>
                <li><code>pool</code>: Ceph存储池名称</li>
                <li><code>user</code>: Ceph用户名称</li>
                <li><code>keyring</code>: 密钥环文件路径（可选）</li>
              </ul>
            </div>
          </div>
        </nz-tab>
        
        <nz-tab nzTitle="iSCSI">
          <div class="config-example">
            <h4>iSCSI 存储配置</h4>
            <p>适用于网络块存储</p>
            <pre><code>{{ '{' }}
  "target": "iqn.2023-01.com.example:storage.vm",
  "portal": "192.168.1.10:3260",
  "lun": 0,
  "auth": {{ '{' }}
    "username": "user",
    "password": "password"
  {{ '}' }}
{{ '}' }}</code></pre>
            <div class="config-description">
              <strong>字段说明：</strong>
              <ul>
                <li><code>target</code>: iSCSI目标名称</li>
                <li><code>portal</code>: iSCSI门户地址</li>
                <li><code>lun</code>: 逻辑单元号</li>
                <li><code>auth</code>: 认证信息（可选）</li>
              </ul>
            </div>
          </div>
        </nz-tab>
      </nz-tabs>
    </div>
  </div>
</nz-modal>

<ng-template #totalTemplate let-total>
  共 {{ total }} 条记录
</ng-template>
