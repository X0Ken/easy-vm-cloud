<nz-card>
  <div class="page-header">
    <div class="header-left">
      <h2>
        <i nz-icon nzType="camera" nzTheme="outline"></i>
        快照管理
      </h2>
      <p>管理存储卷快照，支持创建、删除和恢复操作</p>
    </div>
    <div class="header-right">
      <button nz-button nzType="primary" (click)="showCreateModal()">
        <i nz-icon nzType="plus"></i>
        创建快照
      </button>
      <button nz-button (click)="refresh()">
        <i nz-icon nzType="reload"></i>
        刷新
      </button>
    </div>
  </div>

  <nz-divider></nz-divider>

  <!-- 筛选区域 -->
  <div class="filter-section">
    <nz-space nzSize="middle">
      <nz-select
        *nzSpaceItem
        [(ngModel)]="filterVolumeId"
        nzPlaceHolder="选择存储卷"
        nzAllowClear
        nzShowSearch
        style="width: 200px"
        [nzLoading]="loadingVolumes"
      >
        <nz-option
          *ngFor="let volume of volumes"
          [nzValue]="volume.id"
          [nzLabel]="volume.name"
        ></nz-option>
      </nz-select>

      <nz-select
        *nzSpaceItem
        [(ngModel)]="filterStatus"
        nzPlaceHolder="选择状态"
        nzAllowClear
        style="width: 150px"
      >
        <nz-option nzValue="creating" nzLabel="创建中"></nz-option>
        <nz-option nzValue="available" nzLabel="可用"></nz-option>
        <nz-option nzValue="deleting" nzLabel="删除中"></nz-option>
        <nz-option nzValue="error" nzLabel="错误"></nz-option>
      </nz-select>

      <button *nzSpaceItem nz-button nzType="primary" (click)="applyFilter()">
        <i nz-icon nzType="search"></i>
        查询
      </button>

      <button *nzSpaceItem nz-button (click)="resetFilter()">
        <i nz-icon nzType="redo"></i>
        重置
      </button>
    </nz-space>
  </div>

  <nz-divider></nz-divider>

  <!-- 数据表格 -->
  <nz-table
    #snapshotTable
    [nzData]="snapshots"
    [nzLoading]="loading"
    [nzTotal]="total"
    [nzPageSize]="pageSize"
    [nzPageIndex]="pageIndex"
    [nzFrontPagination]="false"
    [nzShowSizeChanger]="true"
    [nzPageSizeOptions]="[10, 20, 50, 100]"
    (nzPageIndexChange)="onPageIndexChange($event)"
    (nzPageSizeChange)="onPageSizeChange($event)"
    nzShowPagination
  >
    <thead>
      <tr>
        <th nzWidth="200px">快照名称</th>
        <th nzWidth="200px">存储卷</th>
        <th nzWidth="120px">状态</th>
        <th nzWidth="120px">大小</th>
        <th nzWidth="200px">快照标签</th>
        <th>描述</th>
        <th nzWidth="180px">创建时间</th>
        <th nzWidth="200px" nzRight>操作</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let snapshot of snapshotTable.data">
        <td>
          <strong>{{ snapshot.name }}</strong>
        </td>
        <td>
          <span nz-tooltip [nzTooltipTitle]="snapshot.volume_id">
            {{ snapshot.volume_name || snapshot.volume_id }}
          </span>
        </td>
        <td>
          <nz-tag [nzColor]="getStatusColor(snapshot.status)">
            {{ getStatusText(snapshot.status) }}
          </nz-tag>
        </td>
        <td>{{ formatSize(snapshot.size_gb) }}</td>
        <td>
          <span *ngIf="snapshot.snapshot_tag; else noTag">
            {{ snapshot.snapshot_tag }}
          </span>
          <ng-template #noTag>
            <span style="color: #999">-</span>
          </ng-template>
        </td>
        <td>
          <span *ngIf="snapshot.description; else noDesc">
            {{ snapshot.description }}
          </span>
          <ng-template #noDesc>
            <span style="color: #999">-</span>
          </ng-template>
        </td>
        <td>{{ formatDate(snapshot.created_at) }}</td>
        <td nzRight>
          <nz-space nzSize="small">
            <button
              *nzSpaceItem
              nz-button
              nzSize="small"
              (click)="showEditModal(snapshot)"
              nz-tooltip
              nzTooltipTitle="编辑快照"
            >
              <i nz-icon nzType="edit"></i>
              编辑
            </button>

            <button
              *nzSpaceItem
              nz-button
              nzType="primary"
              nzSize="small"
              [disabled]="!canRestore(snapshot)"
              (click)="restoreSnapshot(snapshot)"
              nz-tooltip
              nzTooltipTitle="恢复到此快照"
            >
              <i nz-icon nzType="rollback"></i>
              恢复
            </button>

            <button
              *nzSpaceItem
              nz-button
              nzDanger
              nzSize="small"
              nz-popconfirm
              nzPopconfirmTitle="确定要删除这个快照吗？"
              nzPopconfirmPlacement="topRight"
              [disabled]="!canDelete(snapshot)"
              (nzOnConfirm)="deleteSnapshot(snapshot)"
            >
              <i nz-icon nzType="delete"></i>
              删除
            </button>
          </nz-space>
        </td>
      </tr>
    </tbody>
  </nz-table>
</nz-card>

<!-- 创建快照模态框 -->
<nz-modal
  [(nzVisible)]="isCreateModalVisible"
  nzTitle="创建快照"
  nzWidth="600px"
  (nzOnCancel)="handleCancelCreate()"
  (nzOnOk)="handleCreateSnapshot()"
  [nzOkLoading]="createLoading"
  nzOkText="创建"
  nzCancelText="取消"
>
  <ng-container *nzModalContent>
    <form nz-form [formGroup]="createForm" nzLayout="vertical">
      <nz-form-item>
        <nz-form-label nzRequired nzFor="volume_id">存储卷</nz-form-label>
        <nz-form-control nzErrorTip="请选择存储卷">
          <nz-select
            formControlName="volume_id"
            nzPlaceHolder="请选择存储卷"
            nzShowSearch
            [nzLoading]="loadingVolumes"
          >
            <nz-option
              *ngFor="let volume of volumes"
              [nzValue]="volume.id"
              [nzLabel]="volume.name"
            ></nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label nzRequired nzFor="name">快照名称</nz-form-label>
        <nz-form-control nzErrorTip="请输入快照名称">
          <input nz-input formControlName="name" placeholder="请输入快照名称" id="name" />
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label nzFor="description">描述</nz-form-label>
        <nz-form-control>
          <textarea
            nz-input
            formControlName="description"
            placeholder="请输入快照描述（可选）"
            [nzAutosize]="{ minRows: 3, maxRows: 6 }"
          ></textarea>
        </nz-form-control>
      </nz-form-item>
    </form>
  </ng-container>
</nz-modal>

<!-- 编辑快照模态框 -->
<nz-modal
  [(nzVisible)]="isEditModalVisible"
  nzTitle="编辑快照"
  nzWidth="600px"
  (nzOnCancel)="handleCancelEdit()"
  (nzOnOk)="handleEditSnapshot()"
  [nzOkLoading]="editLoading"
  nzOkText="保存"
  nzCancelText="取消"
>
  <ng-container *nzModalContent>
    <form nz-form [formGroup]="editForm" nzLayout="vertical">
      <nz-form-item>
        <nz-form-label nzRequired nzFor="edit_name">快照名称</nz-form-label>
        <nz-form-control nzErrorTip="请输入快照名称">
          <input nz-input formControlName="name" placeholder="请输入快照名称" id="edit_name" />
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label nzFor="edit_description">描述</nz-form-label>
        <nz-form-control>
          <textarea
            nz-input
            formControlName="description"
            placeholder="请输入快照描述（可选）"
            [nzAutosize]="{ minRows: 3, maxRows: 6 }"
          ></textarea>
        </nz-form-control>
      </nz-form-item>
    </form>
  </ng-container>
</nz-modal>
