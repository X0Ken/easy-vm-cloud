# é¡¹ç›®ç»“æ„è¯´æ˜

æœ¬æ–‡æ¡£æè¿°äº† Easy VM Cloud é¡¹ç›®çš„æ ¸å¿ƒç›®å½•ç»“æ„å’Œæ–‡ä»¶ç»„ç»‡æ–¹å¼ã€‚

## ğŸ“ æ ¸å¿ƒé¡¹ç›®ç»“æ„

```
easy-vm-cloud/                      # é¡¹ç›®æ ¹ç›®å½•
â”œâ”€â”€ README.md                       # é¡¹ç›®ä¸»æ–‡æ¡£
â”œâ”€â”€ Cargo.toml                     # Rust Workspace é…ç½®
â”‚
â”œâ”€â”€ docs/                          # é¡¹ç›®æ–‡æ¡£
â”‚
â”œâ”€â”€ crates/                        # Rust æ ¸å¿ƒæ¨¡å—
â”‚   â”‚
â”‚   â”œâ”€â”€ common/                    # å…¬å…±åº“
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ models/           # å…±äº«æ•°æ®æ¨¡å‹
â”‚   â”‚   â”‚   â”œâ”€â”€ ws_rpc/           # WebSocket RPC æ¡†æ¶
â”‚   â”‚   â”‚   â”œâ”€â”€ errors.rs         # é”™è¯¯å¤„ç†
â”‚   â”‚   â”‚   â””â”€â”€ utils/            # å·¥å…·å‡½æ•°
â”‚   â”‚   â””â”€â”€ Cargo.toml
â”‚   â”‚
â”‚   â”œâ”€â”€ server/                    # åç«¯æœåŠ¡å™¨
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ main.rs           # æœåŠ¡å™¨å…¥å£
â”‚   â”‚   â”‚   â”œâ”€â”€ api/              # REST API æ¥å£ç›®å½•
â”‚   â”‚   â”‚   â”œâ”€â”€ services/         # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”‚   â”‚   â”œâ”€â”€ ws/               # WebSocket æœåŠ¡
â”‚   â”‚   â”‚   â”œâ”€â”€ db/               # æ•°æ®åº“è®¿é—®å±‚
â”‚   â”‚   â”‚   â”œâ”€â”€ auth/             # è®¤è¯æˆæƒ
â”‚   â”‚   â”‚   â”œâ”€â”€ config.rs         # é…ç½®ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ app_state.rs      # åº”ç”¨çŠ¶æ€
â”‚   â”‚   â”‚   â”œâ”€â”€ middleware.rs     # ä¸­é—´ä»¶
â”‚   â”‚   â”‚   â”œâ”€â”€ extractors.rs     # æå–å™¨
â”‚   â”‚   â”‚   â””â”€â”€ utils.rs          # å·¥å…·å‡½æ•°
â”‚   â”‚   â””â”€â”€ Cargo.toml
â”‚   â”‚
â”‚   â””â”€â”€ agent/                     # èŠ‚ç‚¹ä»£ç†
â”‚       â”œâ”€â”€ src/
â”‚       â”‚   â”œâ”€â”€ main.rs           # Agent å…¥å£
â”‚       â”‚   â”œâ”€â”€ ws/               # WebSocket å®¢æˆ·ç«¯
â”‚       â”‚   â”‚   â”œâ”€â”€ client.rs     # WebSocket å®¢æˆ·ç«¯
â”‚       â”‚   â”‚   â””â”€â”€ handler.rs    # RPC è¯·æ±‚å¤„ç†å™¨
â”‚       â”‚   â”œâ”€â”€ hypervisor/       # è™šæ‹ŸåŒ–ç®¡ç†
â”‚       â”‚   â”‚   â””â”€â”€ manager.rs    # è™šæ‹ŸåŒ–ç®¡ç†å™¨
â”‚       â”‚   â”œâ”€â”€ storage/          # å­˜å‚¨ç®¡ç†
â”‚       â”‚   â”œâ”€â”€ network/          # ç½‘ç»œç®¡ç†
â”‚       â”‚   â”œâ”€â”€ metrics/          # æŒ‡æ ‡æ”¶é›†
â”‚       â”‚   â””â”€â”€ config.rs         # é…ç½®ç®¡ç†
â”‚       â””â”€â”€ Cargo.toml
â”‚
â””â”€â”€ frontend/                      # Angular å‰ç«¯
    â”œâ”€â”€ src/
    â”‚   â”œâ”€â”€ app/
    â”‚   â”‚   â”œâ”€â”€ pages/            # é¡µé¢ç»„ä»¶
    â”‚   â”‚   â”‚   â”œâ”€â”€ login/        # ç™»å½•é¡µé¢
    â”‚   â”‚   â”‚   â”œâ”€â”€ vms/          # è™šæ‹Ÿæœºç®¡ç†
    â”‚   â”‚   â”‚   â”œâ”€â”€ network/      # ç½‘ç»œç®¡ç†
    â”‚   â”‚   â”‚   â”œâ”€â”€ storage/      # å­˜å‚¨ç®¡ç†
    â”‚   â”‚   â”‚   â”œâ”€â”€ nodes/        # èŠ‚ç‚¹ç®¡ç†
    â”‚   â”‚   â”‚   â”œâ”€â”€ system/       # ç³»ç»Ÿç®¡ç†
    â”‚   â”‚   â”‚   â”œâ”€â”€ permissions/  # æƒé™ç®¡ç†
    â”‚   â”‚   â”‚   â”œâ”€â”€ me/           # ä¸ªäººä¸­å¿ƒ
    â”‚   â”‚   â”‚   â””â”€â”€ welcome/      # æ¬¢è¿é¡µé¢
    â”‚   â”‚   â”œâ”€â”€ services/         # æœåŠ¡å±‚
    â”‚   â”‚   â”œâ”€â”€ guards/           # è·¯ç”±å®ˆå«
    â”‚   â”‚   â”œâ”€â”€ interceptors/     # HTTP æ‹¦æˆªå™¨
    â”‚   â”‚   â”œâ”€â”€ models/           # æ•°æ®æ¨¡å‹
    â”‚   â”‚   â”œâ”€â”€ config/           # é…ç½®æ¨¡å—
    â”‚   â”‚   â”œâ”€â”€ shared/           # å…±äº«æ¨¡å—
    â”‚   â”‚   â”œâ”€â”€ app.ts            # æ ¹ç»„ä»¶
    â”‚   â”‚   â”œâ”€â”€ app.routes.ts     # è·¯ç”±é…ç½®
    â”‚   â”‚   â”œâ”€â”€ app.config.ts     # åº”ç”¨é…ç½®
    â”‚   â”‚   â”œâ”€â”€ app.html          # æ ¹æ¨¡æ¿
    â”‚   â”‚   â”œâ”€â”€ app.scss          # æ ¹æ ·å¼
    â”‚   â”‚   â”œâ”€â”€ app.spec.ts       # æ ¹ç»„ä»¶æµ‹è¯•
    â”‚   â”‚   â””â”€â”€ icons-provider.ts # å›¾æ ‡æä¾›è€…
    â”‚   â”œâ”€â”€ assets/               # é™æ€èµ„æº
    â”‚   â”œâ”€â”€ environments/         # ç¯å¢ƒé…ç½®
    â”‚   â””â”€â”€ main.ts               # åº”ç”¨å…¥å£
    â””â”€â”€ package.json
```


## ğŸš€ æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

### 1. Common å…¬å…±åº“

- ç»Ÿä¸€çš„é”™è¯¯å¤„ç† (`Error` å’Œ `Result` ç±»å‹)
- å…±äº«æ•°æ®æ¨¡å‹ (èŠ‚ç‚¹çŠ¶æ€ã€VM çŠ¶æ€ã€ä»»åŠ¡ç±»å‹ç­‰)
- WebSocket RPC æ¡†æ¶ï¼ˆæ¶ˆæ¯ã€é”™è¯¯ã€ç±»å‹å®šä¹‰ï¼‰
- å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯è¾…åŠ©å·¥å…·
- å·¥å…·å‡½æ•° (ID ç”Ÿæˆã€æ ¼å¼åŒ–ã€éªŒè¯ç­‰)

### 2. Server åç«¯

**REST API æ¥å£ç›®å½•**:
- `api/auth.rs` - è®¤è¯ç›¸å…³æ¥å£
- `api/nodes.rs` - èŠ‚ç‚¹ç®¡ç†æ¥å£
- `api/vms.rs` - è™šæ‹Ÿæœºç®¡ç†æ¥å£
- `api/storage.rs` - å­˜å‚¨ç®¡ç†æ¥å£
- `api/networks.rs` - ç½‘ç»œç®¡ç†æ¥å£
- `api/user.rs` - ç”¨æˆ·ç®¡ç†æ¥å£
- `api/role.rs` - è§’è‰²ç®¡ç†æ¥å£
- `api/permission.rs` - æƒé™ç®¡ç†æ¥å£
- `api/department.rs` - éƒ¨é—¨ç®¡ç†æ¥å£

**WebSocket æœåŠ¡**:
- `ws/` - WebSocket æœåŠ¡ç›®å½•
- ç®¡ç†æ‰€æœ‰ Agent çš„ WebSocket è¿æ¥
- å¿ƒè·³ç›‘æ§å’Œè¶…æ—¶æ£€æµ‹

**ä¸šåŠ¡é€»è¾‘å±‚**:
- `services/node_service.rs` - èŠ‚ç‚¹ç®¡ç†æœåŠ¡
- `services/vm_service.rs` - è™šæ‹Ÿæœºç®¡ç†æœåŠ¡
- `services/storage_service.rs` - å­˜å‚¨ç®¡ç†æœåŠ¡
- `services/network_service.rs` - ç½‘ç»œç®¡ç†æœåŠ¡
- `services/user_service.rs` - ç”¨æˆ·ç®¡ç†æœåŠ¡
- `services/task_service.rs` - ä»»åŠ¡ç®¡ç†æœåŠ¡

### 3. Agent èŠ‚ç‚¹ä»£ç†

**WebSocket å®¢æˆ·ç«¯**:
- `ws/client.rs` - WebSocket å®¢æˆ·ç«¯
- `ws/handler.rs` - RPC è¯·æ±‚å¤„ç†å™¨
- è¿æ¥åˆ° Server çš„ `/ws/agent` ç«¯ç‚¹
- è‡ªåŠ¨æ³¨å†Œå’Œå¿ƒè·³ä¸ŠæŠ¥
- æ–­çº¿è‡ªåŠ¨é‡è¿ï¼ˆ5ç§’é—´éš”ï¼‰

**ç»„ä»¶æ¨¡å—**:
- `hypervisor/manager.rs` - è™šæ‹ŸåŒ–ç®¡ç†å™¨
- `storage/` - å­˜å‚¨ç®¡ç†ç›®å½•
- `network/` - ç½‘ç»œç®¡ç†ç›®å½•
- `metrics/` - æŒ‡æ ‡æ”¶é›†ç›®å½•
- `ws/` - WebSocket å®¢æˆ·ç«¯ç›®å½•

### 4. Frontend å‰ç«¯

**æ ¸å¿ƒé¡µé¢ç›®å½•**:
- `pages/login/` - ç™»å½•é¡µé¢
- `pages/vms/` - è™šæ‹Ÿæœºç®¡ç†
- `pages/network/` - ç½‘ç»œç®¡ç†
- `pages/storage/` - å­˜å‚¨ç®¡ç†
- `pages/nodes/` - èŠ‚ç‚¹ç®¡ç†
- `pages/system/` - ç³»ç»Ÿç®¡ç†
- `pages/permissions/` - æƒé™ç®¡ç†
- `pages/me/` - ä¸ªäººä¸­å¿ƒ
- `pages/welcome/` - æ¬¢è¿é¡µé¢

**æ ¸å¿ƒæœåŠ¡ç›®å½•**:
- `services/` - æœåŠ¡å±‚ç›®å½•
- `guards/` - è·¯ç”±å®ˆå«ç›®å½•
- `interceptors/` - HTTP æ‹¦æˆªå™¨ç›®å½•
- `models/` - æ•°æ®æ¨¡å‹ç›®å½•
- `config/` - é…ç½®æ¨¡å—ç›®å½•
- `shared/` - å…±äº«æ¨¡å—ç›®å½•

## ğŸ“ æ¶æ„è¯´æ˜

### Rust Workspace ç»“æ„

é¡¹ç›®ä½¿ç”¨ Cargo Workspace ç®¡ç†å¤šä¸ªç›¸å…³çš„ Rust é¡¹ç›®ï¼š

- **`crates/common/`**: å…±äº«åº“ï¼ŒåŒ…å«é€šç”¨æ•°æ®ç»“æ„ã€WebSocket RPC æ¡†æ¶ã€é”™è¯¯å¤„ç†ç­‰
- **`crates/server/`**: åç«¯æœåŠ¡å™¨ï¼Œæä¾› REST APIï¼Œç®¡ç†ä¸šåŠ¡é€»è¾‘
- **`crates/agent/`**: èŠ‚ç‚¹ä»£ç†ï¼Œè¿è¡Œåœ¨å®¿ä¸»æœºä¸Šï¼Œæ‰§è¡Œå®é™…çš„è™šæ‹ŸåŒ–æ“ä½œ

### é€šä¿¡æ¶æ„

- **å‰ç«¯ â†” Server**: HTTPS/REST JSON API
- **Server â†” Agent**: WebSocketï¼ˆåŒå‘ RPCï¼ŒJSON æ¶ˆæ¯æ ¼å¼ï¼‰
  - Agent ä¸»åŠ¨è¿æ¥åˆ° Server
  - Server ç»´æŠ¤æ‰€æœ‰åœ¨çº¿ Agent çš„è¿æ¥
  - æ”¯æŒè¯·æ±‚/å“åº”ã€é€šçŸ¥å’Œæµå¼æ•°æ®ä¼ è¾“
  - å¿ƒè·³æœºåˆ¶ï¼š30ç§’é—´éš”ï¼Œ90ç§’è¶…æ—¶
- **Server â†” PostgreSQL**: æ•°æ®æŒä¹…åŒ–
- **Agent â†” è™šæ‹ŸåŒ–æ ˆ**: æœ¬åœ°è°ƒç”¨ï¼ˆlibvirtã€OVSã€LVM ç­‰ï¼‰

### WebSocket RPC åè®®

è¯¦ç»†åè®®è§„èŒƒè¯·å‚è€ƒ `docs/websocket-rpc-protocol.md`ï¼ŒåŒ…æ‹¬ï¼š
- æ¶ˆæ¯æ ¼å¼å®šä¹‰
- RPC æ–¹æ³•åˆ—è¡¨
- è¿æ¥ç”Ÿå‘½å‘¨æœŸ
- é”™è¯¯å¤„ç†
- å®‰å…¨æ€§è€ƒè™‘
